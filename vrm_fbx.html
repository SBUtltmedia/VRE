<!DOCTYPE html>
<html>

<head>
    <title>A-Frame Examples</title>
    <meta name="description" content="Testing VRM Avatars with FBX animations">
    <link rel="icon" type="image/png" href="data:image/png;base64,iVBORw0KGgo=">

    <script src="js/aframe-v1.7.1.js"></script>

    <!-- Polyfills for FBXLoader compatibility -->
    <script>
    // Create a Math object that references MathUtils for compatibility
    if (!THREE.Math) {
      THREE.Math = THREE.MathUtils;
    }

    // Add missing THREE.MathUtils methods for FBXLoader compatibility
    if (THREE.MathUtils && !THREE.MathUtils.degToRad) {
      THREE.MathUtils.degToRad = function(degrees) {
        return degrees * THREE.MathUtils.DEG2RAD;
      };
    }
    if (THREE.MathUtils && !THREE.MathUtils.radToDeg) {
      THREE.MathUtils.radToDeg = function(radians) {
        return radians * THREE.MathUtils.RAD2DEG;
      };
    }
    if (!THREE.LoaderUtils.extractUrlBase) {
      THREE.LoaderUtils.extractUrlBase = function(url) {
        const index = url.lastIndexOf('/');
        if (index === -1) return './';
        return url.substr(0, index + 1);
      };
    }
    </script>

    <script src="js/aframe-extras.min.js"></script>
    <script src="js/aframe-environment-component.js"></script>
    <script src="js/controller-listener.js"></script>
    <script src="js/player-move.js"></script>
    <script src="js/raycaster-extras.js"></script>

    <!-- Official three-vrm libraries (compatible with A-Frame's Three.js r137) -->
    <script src="js/three-vrm.js"></script>
    <script src="js/three-vrm-animation.js"></script>

    <!-- Custom A-Frame VRM component bundle using official libraries -->
    <script src="js/aframe-vrm-bundle.js"></script>

    <!-- Zlib for compressed FBX files -->
    <script src="https://cdn.jsdelivr.net/npm/zlibjs@0.3.1/bin/inflate.min.js"></script>

    <!-- FBX animation retargeting component -->
    <script src="js/aframe-fbx-retarget.js"></script>

</head>

<body>
<a href="cmu_fbx/CMU_fbx/01_01.fbx">link to fbx</a>

<style>
#debug-console {
    position: fixed;
    top: 10px;
    left: 10px;
    width: 400px;
    max-height: 300px;
    overflow-y: auto;
    background: rgba(0,0,0,0.8);
    color: #0f0;
    font-family: monospace;
    font-size: 10px;
    padding: 10px;
    z-index: 1000;
    border: 1px solid #0f0;
}
</style>

<div id="debug-console"></div>

<script>
// Intercept console.log
const debugDiv = document.getElementById('debug-console');
const originalLog = console.log;
console.log = function(...args) {
    originalLog.apply(console, args);
    const msg = args.map(a => typeof a === 'object' ? JSON.stringify(a) : a).join(' ');
    debugDiv.innerHTML += msg + '<br>';
    debugDiv.scrollTop = debugDiv.scrollHeight;
};

// if raycaster is pointing at this object, press trigger to change color
AFRAME.registerComponent("vrm-test", {
    init: function ()
    {

        // replace GLTF MeshBasicMaterial with Material that supports shading
        this.el.addEventListener("model-loaded", function(eventData) {
          console.log("model-loaded!");
          let model = eventData.detail.model;
          model.traverse((obj) => {
            if (obj.isMesh)
            {
              let newMaterial = new THREE.MeshLambertMaterial(
                {alphaTest: 0.5, alphaWrite: false, emissive: "#111111"});
              newMaterial.map = obj.material.map;
              obj.material = newMaterial;
            }
          });

        });
        // Material replacement complete

        // look-at object (check: string used by querySelector?)
        // Use A-Frame's setAttribute with property name to update just the lookAt property
        this.el.setAttribute("vrm", "lookAt", document.querySelector("a-camera"));

        this.clock = new THREE.Clock();
    },

    tick: function()
    {

    }
});

// Load raw FBX for comparison
window.addEventListener('load', () => {
  const loader = new THREE.FBXLoader();
  const entity = document.querySelector('#fbx-raw');

  loader.load('cmu_fbx/CMU_fbx/01_01.fbx', (fbx) => {
    console.log('Raw FBX loaded:', fbx);

    // Scale down to roughly match VRM size (CMU MoCap is in different units)
    fbx.scale.set(0.01, 0.01, 0.01);

    // Add to scene
    entity.setObject3D('mesh', fbx);

    // Play the original animation
    if (fbx.animations && fbx.animations.length > 0) {
      const mixer = new THREE.AnimationMixer(fbx);
      const action = mixer.clipAction(fbx.animations[0]);
      action.play();

      // Update mixer in tick
      entity.setAttribute('animation-mixer', '');
      entity.components['animation-mixer'].mixer = mixer;

      console.log('Raw FBX animation playing');
    }
  }, undefined, (error) => {
    console.error('Error loading raw FBX:', error);
  });
});

</script>

<a-scene>

    <a-assets>
        <img id="gradient" src="images/gradient-fade.png" />
    </a-assets>

    <a-sky
        color = "#000337">
    </a-sky>


    <!-- VRM with CONVERTED FBX animation (Blender-processed with correct Euler angles) -->
    <a-entity vrm="src: models/Asian/Asian_F_1_Busi.vrm;"
              fbx-animation="src: converted_mocap/01_01_converted.fbx; debug: true"
              position="-0.6 0 -1.5"
              rotation="0 180 0"
              vrm-test
              shadow="cast: true; receive: false;"
              >
    </a-entity>

    <!-- Raw FBX with native animation on the right for comparison -->
    <a-entity id="fbx-raw"
              position="0.6 0 -1.5"
              rotation="0 180 0"
              shadow="cast: true; receive: false;">
    </a-entity>

    <a-entity
        id="player"
        position="0 0 1"
        player-move="controllerListenerId: #controller-data;
                     navigationMeshClass: environmentGround;">

        <a-camera></a-camera>

        <a-entity
            id="controller-data"
            controller-listener="leftControllerId:  #left-controller;
                                 rightControllerId: #right-controller;">
        </a-entity>

        <a-entity
            id="left-controller"
            oculus-touch-controls="hand: left">
        </a-entity>

        <a-entity
            id="right-controller"
            oculus-touch-controls="hand: right"
            raycaster="objects: .raycaster-target, .environmentGround;"
            raycaster-extras="controllerListenerId: #controller-data;
                              beamImageSrc: #gradient; beamLength: 0.5;">
        </a-entity>

    </a-entity>





</a-scene>

</body>
</html>