<!DOCTYPE html>
<html>
<head>
    <title>ARKit Shapes Demo</title>
    <meta name="description" content="Demonstrates ARKit facial blend shapes">
    <script src="js/aframe-v1.7.1.js"></script>
    <script src="js/aframe-environment-component.js"></script>
    <script src="js/three-vrm.js"></script>
    <script src="js/three-vrm-animation.js"></script>
    <script src="js/aframe-vrm-bundle.js"></script>
</head>
<body>

<style>
    #info {
        position: fixed;
        top: 20px;
        left: 20px;
        color: white;
        font-family: monospace;
        background: rgba(0,0,0,0.8);
        padding: 15px;
        border-radius: 5px;
        pointer-events: none;
        font-size: 1.2em;
        z-index: 100;
    }
    .highlight {
        color: #00ff00;
        font-weight: bold;
    }
    .category {
        color: #ffaa00;
        font-weight: bold;
    }
    #controls {
        position: fixed;
        bottom: 20px;
        left: 20px;
        background: rgba(0,0,0,0.8);
        padding: 15px;
        border-radius: 5px;
        z-index: 100;
        color: white;
        font-family: monospace;
    }
    select {
        background: #333;
        color: white;
        border: 1px solid #666;
        padding: 5px;
        font-family: monospace;
        margin: 5px;
    }
</style>

<div id="info">
    <div>ARKit Shapes Demo</div>
    <div id="status">Loading model...</div>
    <div id="current-shape" class="highlight"></div>
    <div id="shape-count"></div>
</div>

<div id="controls">
    <div>Mode:
        <select id="modeSelect">
            <option value="cycle">Cycle All</option>
            <option value="eyes">Eyes Only</option>
            <option value="mouth">Mouth Only</option>
            <option value="brows">Brows Only</option>
        </select>
    </div>
    <div>Speed:
        <select id="speedSelect">
            <option value="2.0">Slow</option>
            <option value="1.5" selected>Normal</option>
            <option value="1.0">Fast</option>
            <option value="0.5">Very Fast</option>
        </select>
    </div>
</div>

<script>
    AFRAME.registerComponent('arkit-demo', {
        schema: {
            vrm: { type: 'string', default: 'models/AIAN/AIAN_F_1_Casual_CLEANED.vrm' },
            duration: { type: 'number', default: 1.5 }
        },

        init: function () {
            // ARKit shape categories
            this.arkitShapes = {
                eyes: [
                    'eyeBlinkLeft', 'eyeBlinkRight',
                    'eyeWideLeft', 'eyeWideRight',
                    'eyeSquintLeft', 'eyeSquintRight'
                ],
                jaw: [
                    'jawOpen', 'jawForward', 'jawLeft', 'jawRight'
                ],
                mouth: [
                    'mouthClose', 'mouthFunnel', 'mouthPucker',
                    'mouthLeft', 'mouthRight',
                    'mouthSmileLeft', 'mouthSmileRight',
                    'mouthFrownLeft', 'mouthFrownRight',
                    'mouthDimpleLeft', 'mouthDimpleRight',
                    'mouthStretchLeft', 'mouthStretchRight',
                    'mouthUpperUpLeft', 'mouthUpperUpRight',
                    'mouthLowerDownLeft', 'mouthLowerDownRight',
                    'mouthPressLeft', 'mouthPressRight'
                ],
                brows: [
                    'browDownLeft', 'browDownRight',
                    'browOuterUpLeft', 'browOuterUpRight',
                    'browInnerUp'
                ],
                nose: [
                    'noseSneerLeft', 'noseSneerRight'
                ],
                cheeks: [
                    'cheekPuff'
                ]
            };

            this.allShapes = [];
            for (let cat in this.arkitShapes) {
                this.allShapes = this.allShapes.concat(this.arkitShapes[cat]);
            }

            this.currentIndex = 0;
            this.time = 0;
            this.mode = 'cycle';

            this.vrm = null;
            this.mesh = null;
            this.teethDown = null;
            this.teethUp = null;
            this.availableShapes = [];

            // Mapping of ARKit/face shapes to teeth shapes
            this.teethShapeMap = {
                'jawOpen': 'h_teeth.t_MouthOpen_h',
                'mouthFunnel': 'h_teeth.t_Shout_h',
                'mouthClose': 'h_teeth.t_MPB_h',
                'A': 'h_teeth.t_AE_AA_h',
                'E': 'h_teeth.t_Ax_E_h',
                'I': 'h_teeth.t_TD_I_h',
                'O': 'h_teeth.t_AO_a_h',
                'U': 'h_teeth.t_UW_U_h',
                'F': 'h_teeth.t_FV_h',
                'M': 'h_teeth.t_MPB_h',
                'S': 'h_teeth.t_S_h',
                'CH': 'h_teeth.t_SH_CH_h',
                'K': 'h_teeth.t_KG_h'
            };

            // Bindings
            this.onModelLoaded = this.onModelLoaded.bind(this);
            this.el.addEventListener('model-loaded', this.onModelLoaded);

            // Set VRM src
            this.el.setAttribute('vrm', 'src', this.data.vrm);

            // Setup controls
            this.setupControls();
        },

        onModelLoaded: function (evt) {
            const vrm = evt.detail.vrm;
            if (!vrm) return;

            this.vrm = vrm;
            console.log("VRM loaded");

            // Find the face mesh and teeth meshes
            this.mesh = this.findFaceMesh(this.vrm.scene);
            this.teethDown = this.findMesh(this.vrm.scene, 'h_TeethDown');
            this.teethUp = this.findMesh(this.vrm.scene, 'h_TeethUp');

            if (this.mesh) {
                console.log("Face mesh found:", this.mesh.name);
                if (this.teethDown) console.log("Teeth down found");
                if (this.teethUp) console.log("Teeth up found");

                // Check which ARKit shapes are available
                this.checkAvailableShapes();

                document.getElementById('status').textContent = "Ready. Cycling through ARKit shapes.";
                document.getElementById('shape-count').textContent =
                    `Available: ${this.availableShapes.length} of ${this.allShapes.length} ARKit shapes`;
            } else {
                console.warn("Face mesh not found");
            }
        },

        findFaceMesh: function(root) {
            return this.findMesh(root, 'H_DDS_HighRes');
        },

        findMesh: function(root, meshName) {
            let found = null;
            root.traverse((node) => {
                if (node.isMesh && node.name === meshName) {
                    found = node;
                }
            });
            return found;
        },

        checkAvailableShapes: function() {
            if (!this.mesh || !this.mesh.morphTargetDictionary) return;

            this.availableShapes = [];
            for (let shape of this.allShapes) {
                if (shape in this.mesh.morphTargetDictionary) {
                    this.availableShapes.push(shape);
                }
            }

            console.log(`Available ARKit shapes: ${this.availableShapes.length}/${this.allShapes.length}`);
            console.log('Available:', this.availableShapes);
        },

        setupControls: function() {
            document.getElementById('modeSelect').addEventListener('change', (e) => {
                this.mode = e.target.value;
                this.currentIndex = 0;
                this.time = 0;
                this.resetAllShapes();
            });

            document.getElementById('speedSelect').addEventListener('change', (e) => {
                this.data.duration = parseFloat(e.target.value);
            });
        },

        getShapesForMode: function() {
            switch(this.mode) {
                case 'eyes': return this.arkitShapes.eyes;
                case 'mouth': return this.arkitShapes.mouth;
                case 'brows': return this.arkitShapes.brows;
                default: return this.availableShapes;
            }
        },

        tick: function(t, dt) {
            if (!this.vrm || !this.mesh) return;

            const deltaS = dt / 1000;
            this.time += deltaS;

            const shapes = this.getShapesForMode();

            // Cycle through shapes
            if (this.time > this.data.duration) {
                this.time = 0;
                // Reset previous shape
                this.applyShape(shapes[this.currentIndex], 0);
                this.currentIndex = (this.currentIndex + 1) % shapes.length;
            }

            const currentShape = shapes[this.currentIndex];

            // Calculate intensity: Sine wave 0 -> 1 -> 0
            const progress = this.time / this.data.duration;
            const value = Math.max(0, Math.sin(Math.PI * progress));

            this.applyShape(currentShape, value);

            // Update UI
            const category = this.getShapeCategory(currentShape);
            document.getElementById('current-shape').innerHTML =
                `<span class="category">${category}</span>: ${currentShape} : ${value.toFixed(2)}`;
        },

        getShapeCategory: function(shape) {
            for (let cat in this.arkitShapes) {
                if (this.arkitShapes[cat].includes(shape)) {
                    return cat.toUpperCase();
                }
            }
            return 'OTHER';
        },

        applyShape: function(name, value) {
            // Apply to face mesh
            if (this.mesh && this.mesh.morphTargetDictionary && this.mesh.morphTargetInfluences) {
                if (name in this.mesh.morphTargetDictionary) {
                    const idx = this.mesh.morphTargetDictionary[name];
                    this.mesh.morphTargetInfluences[idx] = value;
                }
            }

            // Apply to teeth if there's a corresponding teeth shape
            const teethShapeName = this.teethShapeMap[name];
            if (teethShapeName) {
                // Apply to teeth down
                if (this.teethDown && this.teethDown.morphTargetDictionary) {
                    if (teethShapeName in this.teethDown.morphTargetDictionary) {
                        const idx = this.teethDown.morphTargetDictionary[teethShapeName];
                        this.teethDown.morphTargetInfluences[idx] = value;
                    }
                }
                // Apply to teeth up
                if (this.teethUp && this.teethUp.morphTargetDictionary) {
                    if (teethShapeName in this.teethUp.morphTargetDictionary) {
                        const idx = this.teethUp.morphTargetDictionary[teethShapeName];
                        this.teethUp.morphTargetInfluences[idx] = value;
                    }
                }
            }
        },

        resetAllShapes: function() {
            if (!this.mesh) return;

            for (let shape of this.allShapes) {
                this.applyShape(shape, 0);
            }
        }
    });
</script>

<a-scene>
    <a-sky color="#1a1a1a"></a-sky>

    <!-- Lighting -->
    <a-entity light="type: ambient; intensity: 0.6;"></a-entity>
    <a-entity light="type: directional; intensity: 1.0; castShadow: true;" position="1 2 3"></a-entity>
    <a-entity light="type: point; intensity: 0.5; color: #ffd;" position="-1 1.5 1"></a-entity>

    <!-- Camera -->
    <a-entity position="0 0 0.6">
        <a-camera fov="50" wasd-controls-enabled="true" look-controls-enabled="true"></a-camera>
        <a-entity light="type: point; intensity: 0.8; distance: 3; decay: 2" position="0 1.6 0"></a-entity>
    </a-entity>

    <!-- Avatar with ARKit Demo -->
    <a-entity
        id="avatar"
        arkit-demo="vrm: models/AIAN/AIAN_F_1_Casual_CLEANED.vrm; duration: 1.5"
        position="0 0 0"
        rotation="0 180 0"
        shadow="cast: true">
    </a-entity>

</a-scene>

</body>
</html>
